{% extends "wirgarten/generic/filter-list.html" %}

{% load i18n %}
{% load core %}
{% load tapir_static %}
{% load wirgarten %}
{% load django_bootstrap5 %}

{% block title %}
{% translate "Mitgliederliste" %}
{% endblock %}

{% block card_header %}
<h4>{{filter.qs | length}} {% translate "Mitgliederliste" %}</h4>
{% endblock %}

{% block table_head %}
<tr>
    <th>{% translate "Mitgliedsnummer" %}</th>
    <th>{% translate "Vorname" %}</th>
    <th>{% translate "Nachname" %}</th>
    <th>{% translate "Adresse" %}</th>
    <th>{% translate "Beitrittsdatum zur Genossenschaft" %}</th>
    <th>{% translate "ursprüngliche Anteilszeichnung" %}</th>
    <th>{% translate "weitere Anteilszeichnungen" %}</th>
    <th>{% translate "Kündigungsdatum" %}</th>
    <th>{% translate "Wirksamkeit Kündigung" %}</th>
</tr>
{% endblock %}

{% block table_body %}
{% for member in object_list %}

<tr id="member-{{member.id}}" onClick="handleSelectMember('{{member.id}}')"
    class="tr-clickable member-row">
    <td class="align-middle">{{ member.first_name }}</td>
    <td class="align-middle">{{ member.last_name }}</td>
    <td class="align-middle">{{ member.birthdate }}</td>
    <td class="align-middle">{{ member.email }}</td>
    <td class="align-middle">{{ member.created_at|format_date }}</td>
</tr>
{% endfor %}
{% endblock %}

{% block script %}
<script>
    const memberRows = document.getElementsByClassName('member-row');
    const buttons = document.getElementsByClassName('needs-member');

    const activateRow = () => {
        const params = Tapir.getUrlParams();

        if(params.member){
            for(row of memberRows){
                if(row.id === `member-${params.member}`){
                    row.classList.add('active');
                } else {
                    row.classList.remove('active');
                }
            }

            for(btn of buttons){
                btn.disabled = false;
            }
        }
    }

    const handleSelectMember = (memberId) => {
        const params = Tapir.getUrlParams();

        if(params.member === memberId){
            handleShowMemberDetailsPage();
        } else {
            params.member = memberId;
            Tapir.replaceUrlParams(params);

            activateRow();
        }
    }

    const handleAddMember = () => {
        FormModal.load('{% url 'wirgarten:member_create' %}', 'Neues Mitglied anlegen');
    }

    const handleShowMemberDetailsPage = () => {
        const params = Tapir.getUrlParams();
        window.open(`/wirgarten/members/${params.member}`, '_blank');
    }

    const handleShowContractPage = () => {
        const params = Tapir.getUrlParams();
        window.location.href = "{% url 'wirgarten:subscription_list' %}?member=" + params.member;
    }

    const handleShowPayments = () => {
        const params = Tapir.getUrlParams();
        window.location.href = `/wirgarten/payments/${params.member}`;
    }

    const handleShowDeliveries = () => {
        const params = Tapir.getUrlParams();
        window.location.href = `/wirgarten/deliveries/${params.member}`;
    }

    const handleTransferCoopShares = () => {
        const params = Tapir.getUrlParams();
        FormModal.load(`/wirgarten/members/${params.member}/coopsharestransfer`, "Genossenschaftsanteile übertragen");
    }

    const handleEditMemberDetails = () => {
        const params = Tapir.getUrlParams();
        FormModal.load(`/wirgarten/members/${params.member}/edit`, 'Persönliche Daten ändern')
        FormModal.addCallback((e) => {
            if(e.data.type === "modal-save-successful"){
                window.location.replace(window.location.href)
            }
        })
    }

    const handleDeleteMember = () => {
        ConfirmationModal.open('Bist du dir sicher?', 'Möchtest du dieses Mitglied wirklich löschen?', 'Löschen', 'danger', () => {
            alert("Not yet implemented!")
        })
    }

    activateRow();
</script>
{% endblock %}