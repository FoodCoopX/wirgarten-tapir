from datetime import date, datetime

from django.test import TestCase

from tapir.wirgarten.service.delivery import (
    calculate_pickup_location_change_date,
    get_next_delivery_date,
)


class PickupLocationChangeDateTestCase(TestCase):
    VALIDATION_DATA = """2023-08-07;2023-08-07;Mon;2023-08-08
2023-08-07;2023-08-07;Tue;2023-08-08
2023-08-07;2023-08-07;Wed;2023-08-08
2023-08-07;2023-08-07;Thu;2023-08-08
2023-08-07;2023-08-07;Fri;2023-08-08
2023-08-07;2023-08-07;Sat;2023-08-08
2023-08-07;2023-08-07;Sun;2023-08-08
2023-08-07;2023-08-08;Mon;2023-08-07
2023-08-07;2023-08-08;Tue;2023-08-09
2023-08-07;2023-08-08;Wed;2023-08-09
2023-08-07;2023-08-08;Thu;2023-08-09
2023-08-07;2023-08-08;Fri;2023-08-09
2023-08-07;2023-08-08;Sat;2023-08-09
2023-08-07;2023-08-08;Sun;2023-08-09
2023-08-07;2023-08-09;Mon;2023-08-07
2023-08-07;2023-08-09;Tue;2023-08-07
2023-08-07;2023-08-09;Wed;2023-08-10
2023-08-07;2023-08-09;Thu;2023-08-10
2023-08-07;2023-08-09;Fri;2023-08-10
2023-08-07;2023-08-09;Sat;2023-08-10
2023-08-07;2023-08-09;Sun;2023-08-10
2023-08-07;2023-08-10;Mon;2023-08-07
2023-08-07;2023-08-10;Tue;2023-08-07
2023-08-07;2023-08-10;Wed;2023-08-07
2023-08-07;2023-08-10;Thu;2023-08-11
2023-08-07;2023-08-10;Fri;2023-08-11
2023-08-07;2023-08-10;Sat;2023-08-11
2023-08-07;2023-08-10;Sun;2023-08-11
2023-08-07;2023-08-11;Mon;2023-08-07
2023-08-07;2023-08-11;Tue;2023-08-07
2023-08-07;2023-08-11;Wed;2023-08-07
2023-08-07;2023-08-11;Thu;2023-08-07
2023-08-07;2023-08-11;Fri;2023-08-12
2023-08-07;2023-08-11;Sat;2023-08-12
2023-08-07;2023-08-11;Sun;2023-08-12
2023-08-07;2023-08-12;Mon;2023-08-07
2023-08-07;2023-08-12;Tue;2023-08-07
2023-08-07;2023-08-12;Wed;2023-08-07
2023-08-07;2023-08-12;Thu;2023-08-07
2023-08-07;2023-08-12;Fri;2023-08-07
2023-08-07;2023-08-12;Sat;2023-08-13
2023-08-07;2023-08-12;Sun;2023-08-13
2023-08-07;2023-08-13;Mon;2023-08-07
2023-08-07;2023-08-13;Tue;2023-08-07
2023-08-07;2023-08-13;Wed;2023-08-07
2023-08-07;2023-08-13;Thu;2023-08-07
2023-08-07;2023-08-13;Fri;2023-08-07
2023-08-07;2023-08-13;Sat;2023-08-07
2023-08-07;2023-08-13;Sun;2023-08-14
2023-08-08;2023-08-14;Mon;2023-08-15
2023-08-08;2023-08-14;Tue;2023-08-08
2023-08-08;2023-08-14;Wed;2023-08-08
2023-08-08;2023-08-14;Thu;2023-08-08
2023-08-08;2023-08-14;Fri;2023-08-08
2023-08-08;2023-08-14;Sat;2023-08-08
2023-08-08;2023-08-14;Sun;2023-08-08
2023-08-08;2023-08-08;Mon;2023-08-09
2023-08-08;2023-08-08;Tue;2023-08-09
2023-08-08;2023-08-08;Wed;2023-08-09
2023-08-08;2023-08-08;Thu;2023-08-09
2023-08-08;2023-08-08;Fri;2023-08-09
2023-08-08;2023-08-08;Sat;2023-08-09
2023-08-08;2023-08-08;Sun;2023-08-09
2023-08-08;2023-08-09;Mon;2023-08-10
2023-08-08;2023-08-09;Tue;2023-08-08
2023-08-08;2023-08-09;Wed;2023-08-10
2023-08-08;2023-08-09;Thu;2023-08-10
2023-08-08;2023-08-09;Fri;2023-08-10
2023-08-08;2023-08-09;Sat;2023-08-10
2023-08-08;2023-08-09;Sun;2023-08-10
2023-08-08;2023-08-10;Mon;2023-08-11
2023-08-08;2023-08-10;Tue;2023-08-08
2023-08-08;2023-08-10;Wed;2023-08-08
2023-08-08;2023-08-10;Thu;2023-08-11
2023-08-08;2023-08-10;Fri;2023-08-11
2023-08-08;2023-08-10;Sat;2023-08-11
2023-08-08;2023-08-10;Sun;2023-08-11
2023-08-08;2023-08-11;Mon;2023-08-12
2023-08-08;2023-08-11;Tue;2023-08-08
2023-08-08;2023-08-11;Wed;2023-08-08
2023-08-08;2023-08-11;Thu;2023-08-08
2023-08-08;2023-08-11;Fri;2023-08-12
2023-08-08;2023-08-11;Sat;2023-08-12
2023-08-08;2023-08-11;Sun;2023-08-12
2023-08-08;2023-08-12;Mon;2023-08-13
2023-08-08;2023-08-12;Tue;2023-08-08
2023-08-08;2023-08-12;Wed;2023-08-08
2023-08-08;2023-08-12;Thu;2023-08-08
2023-08-08;2023-08-12;Fri;2023-08-08
2023-08-08;2023-08-12;Sat;2023-08-13
2023-08-08;2023-08-12;Sun;2023-08-13
2023-08-08;2023-08-13;Mon;2023-08-14
2023-08-08;2023-08-13;Tue;2023-08-08
2023-08-08;2023-08-13;Wed;2023-08-08
2023-08-08;2023-08-13;Thu;2023-08-08
2023-08-08;2023-08-13;Fri;2023-08-08
2023-08-08;2023-08-13;Sat;2023-08-08
2023-08-08;2023-08-13;Sun;2023-08-14
2023-08-09;2023-08-14;Mon;2023-08-15
2023-08-09;2023-08-14;Tue;2023-08-15
2023-08-09;2023-08-14;Wed;2023-08-09
2023-08-09;2023-08-14;Thu;2023-08-09
2023-08-09;2023-08-14;Fri;2023-08-09
2023-08-09;2023-08-14;Sat;2023-08-09
2023-08-09;2023-08-14;Sun;2023-08-09
2023-08-09;2023-08-15;Mon;2023-08-09
2023-08-09;2023-08-15;Tue;2023-08-16
2023-08-09;2023-08-15;Wed;2023-08-09
2023-08-09;2023-08-15;Thu;2023-08-09
2023-08-09;2023-08-15;Fri;2023-08-09
2023-08-09;2023-08-15;Sat;2023-08-09
2023-08-09;2023-08-15;Sun;2023-08-09
2023-08-09;2023-08-09;Mon;2023-08-10
2023-08-09;2023-08-09;Tue;2023-08-10
2023-08-09;2023-08-09;Wed;2023-08-10
2023-08-09;2023-08-09;Thu;2023-08-10
2023-08-09;2023-08-09;Fri;2023-08-10
2023-08-09;2023-08-09;Sat;2023-08-10
2023-08-09;2023-08-09;Sun;2023-08-10
2023-08-09;2023-08-10;Mon;2023-08-11
2023-08-09;2023-08-10;Tue;2023-08-11
2023-08-09;2023-08-10;Wed;2023-08-09
2023-08-09;2023-08-10;Thu;2023-08-11
2023-08-09;2023-08-10;Fri;2023-08-11
2023-08-09;2023-08-10;Sat;2023-08-11
2023-08-09;2023-08-10;Sun;2023-08-11
2023-08-09;2023-08-11;Mon;2023-08-12
2023-08-09;2023-08-11;Tue;2023-08-12
2023-08-09;2023-08-11;Wed;2023-08-09
2023-08-09;2023-08-11;Thu;2023-08-09
2023-08-09;2023-08-11;Fri;2023-08-12
2023-08-09;2023-08-11;Sat;2023-08-12
2023-08-09;2023-08-11;Sun;2023-08-12
2023-08-09;2023-08-12;Mon;2023-08-13
2023-08-09;2023-08-12;Tue;2023-08-13
2023-08-09;2023-08-12;Wed;2023-08-09
2023-08-09;2023-08-12;Thu;2023-08-09
2023-08-09;2023-08-12;Fri;2023-08-09
2023-08-09;2023-08-12;Sat;2023-08-13
2023-08-09;2023-08-12;Sun;2023-08-13
2023-08-09;2023-08-13;Mon;2023-08-14
2023-08-09;2023-08-13;Tue;2023-08-14
2023-08-09;2023-08-13;Wed;2023-08-09
2023-08-09;2023-08-13;Thu;2023-08-09
2023-08-09;2023-08-13;Fri;2023-08-09
2023-08-09;2023-08-13;Sat;2023-08-09
2023-08-09;2023-08-13;Sun;2023-08-14
2023-08-10;2023-08-14;Mon;2023-08-15
2023-08-10;2023-08-14;Tue;2023-08-15
2023-08-10;2023-08-14;Wed;2023-08-15
2023-08-10;2023-08-14;Thu;2023-08-10
2023-08-10;2023-08-14;Fri;2023-08-10
2023-08-10;2023-08-14;Sat;2023-08-10
2023-08-10;2023-08-14;Sun;2023-08-10
2023-08-10;2023-08-15;Mon;2023-08-10
2023-08-10;2023-08-15;Tue;2023-08-16
2023-08-10;2023-08-15;Wed;2023-08-16
2023-08-10;2023-08-15;Thu;2023-08-10
2023-08-10;2023-08-15;Fri;2023-08-10
2023-08-10;2023-08-15;Sat;2023-08-10
2023-08-10;2023-08-15;Sun;2023-08-10
2023-08-10;2023-08-16;Mon;2023-08-10
2023-08-10;2023-08-16;Tue;2023-08-10
2023-08-10;2023-08-16;Wed;2023-08-17
2023-08-10;2023-08-16;Thu;2023-08-10
2023-08-10;2023-08-16;Fri;2023-08-10
2023-08-10;2023-08-16;Sat;2023-08-10
2023-08-10;2023-08-16;Sun;2023-08-10
2023-08-10;2023-08-10;Mon;2023-08-11
2023-08-10;2023-08-10;Tue;2023-08-11
2023-08-10;2023-08-10;Wed;2023-08-11
2023-08-10;2023-08-10;Thu;2023-08-11
2023-08-10;2023-08-10;Fri;2023-08-11
2023-08-10;2023-08-10;Sat;2023-08-11
2023-08-10;2023-08-10;Sun;2023-08-11
2023-08-10;2023-08-11;Mon;2023-08-12
2023-08-10;2023-08-11;Tue;2023-08-12
2023-08-10;2023-08-11;Wed;2023-08-12
2023-08-10;2023-08-11;Thu;2023-08-10
2023-08-10;2023-08-11;Fri;2023-08-12
2023-08-10;2023-08-11;Sat;2023-08-12
2023-08-10;2023-08-11;Sun;2023-08-12
2023-08-10;2023-08-12;Mon;2023-08-13
2023-08-10;2023-08-12;Tue;2023-08-13
2023-08-10;2023-08-12;Wed;2023-08-13
2023-08-10;2023-08-12;Thu;2023-08-10
2023-08-10;2023-08-12;Fri;2023-08-10
2023-08-10;2023-08-12;Sat;2023-08-13
2023-08-10;2023-08-12;Sun;2023-08-13
2023-08-10;2023-08-13;Mon;2023-08-14
2023-08-10;2023-08-13;Tue;2023-08-14
2023-08-10;2023-08-13;Wed;2023-08-14
2023-08-10;2023-08-13;Thu;2023-08-10
2023-08-10;2023-08-13;Fri;2023-08-10
2023-08-10;2023-08-13;Sat;2023-08-10
2023-08-10;2023-08-13;Sun;2023-08-14
2023-08-11;2023-08-14;Mon;2023-08-15
2023-08-11;2023-08-14;Tue;2023-08-15
2023-08-11;2023-08-14;Wed;2023-08-15
2023-08-11;2023-08-14;Thu;2023-08-15
2023-08-11;2023-08-14;Fri;2023-08-11
2023-08-11;2023-08-14;Sat;2023-08-11
2023-08-11;2023-08-14;Sun;2023-08-11
2023-08-11;2023-08-15;Mon;2023-08-11
2023-08-11;2023-08-15;Tue;2023-08-16
2023-08-11;2023-08-15;Wed;2023-08-16
2023-08-11;2023-08-15;Thu;2023-08-16
2023-08-11;2023-08-15;Fri;2023-08-11
2023-08-11;2023-08-15;Sat;2023-08-11
2023-08-11;2023-08-15;Sun;2023-08-11
2023-08-11;2023-08-16;Mon;2023-08-11
2023-08-11;2023-08-16;Tue;2023-08-11
2023-08-11;2023-08-16;Wed;2023-08-17
2023-08-11;2023-08-16;Thu;2023-08-17
2023-08-11;2023-08-16;Fri;2023-08-11
2023-08-11;2023-08-16;Sat;2023-08-11
2023-08-11;2023-08-16;Sun;2023-08-11
2023-08-11;2023-08-17;Mon;2023-08-11
2023-08-11;2023-08-17;Tue;2023-08-11
2023-08-11;2023-08-17;Wed;2023-08-11
2023-08-11;2023-08-17;Thu;2023-08-18
2023-08-11;2023-08-17;Fri;2023-08-11
2023-08-11;2023-08-17;Sat;2023-08-11
2023-08-11;2023-08-17;Sun;2023-08-11
2023-08-11;2023-08-11;Mon;2023-08-12
2023-08-11;2023-08-11;Tue;2023-08-12
2023-08-11;2023-08-11;Wed;2023-08-12
2023-08-11;2023-08-11;Thu;2023-08-12
2023-08-11;2023-08-11;Fri;2023-08-12
2023-08-11;2023-08-11;Sat;2023-08-12
2023-08-11;2023-08-11;Sun;2023-08-12
2023-08-11;2023-08-12;Mon;2023-08-13
2023-08-11;2023-08-12;Tue;2023-08-13
2023-08-11;2023-08-12;Wed;2023-08-13
2023-08-11;2023-08-12;Thu;2023-08-13
2023-08-11;2023-08-12;Fri;2023-08-11
2023-08-11;2023-08-12;Sat;2023-08-13
2023-08-11;2023-08-12;Sun;2023-08-13
2023-08-11;2023-08-13;Mon;2023-08-14
2023-08-11;2023-08-13;Tue;2023-08-14
2023-08-11;2023-08-13;Wed;2023-08-14
2023-08-11;2023-08-13;Thu;2023-08-14
2023-08-11;2023-08-13;Fri;2023-08-11
2023-08-11;2023-08-13;Sat;2023-08-11
2023-08-11;2023-08-13;Sun;2023-08-14
2023-08-12;2023-08-14;Mon;2023-08-15
2023-08-12;2023-08-14;Tue;2023-08-15
2023-08-12;2023-08-14;Wed;2023-08-15
2023-08-12;2023-08-14;Thu;2023-08-15
2023-08-12;2023-08-14;Fri;2023-08-15
2023-08-12;2023-08-14;Sat;2023-08-12
2023-08-12;2023-08-14;Sun;2023-08-12
2023-08-12;2023-08-15;Mon;2023-08-12
2023-08-12;2023-08-15;Tue;2023-08-16
2023-08-12;2023-08-15;Wed;2023-08-16
2023-08-12;2023-08-15;Thu;2023-08-16
2023-08-12;2023-08-15;Fri;2023-08-16
2023-08-12;2023-08-15;Sat;2023-08-12
2023-08-12;2023-08-15;Sun;2023-08-12
2023-08-12;2023-08-16;Mon;2023-08-12
2023-08-12;2023-08-16;Tue;2023-08-12
2023-08-12;2023-08-16;Wed;2023-08-17
2023-08-12;2023-08-16;Thu;2023-08-17
2023-08-12;2023-08-16;Fri;2023-08-17
2023-08-12;2023-08-16;Sat;2023-08-12
2023-08-12;2023-08-16;Sun;2023-08-12
2023-08-12;2023-08-17;Mon;2023-08-12
2023-08-12;2023-08-17;Tue;2023-08-12
2023-08-12;2023-08-17;Wed;2023-08-12
2023-08-12;2023-08-17;Thu;2023-08-18
2023-08-12;2023-08-17;Fri;2023-08-18
2023-08-12;2023-08-17;Sat;2023-08-12
2023-08-12;2023-08-17;Sun;2023-08-12
2023-08-12;2023-08-18;Mon;2023-08-12
2023-08-12;2023-08-18;Tue;2023-08-12
2023-08-12;2023-08-18;Wed;2023-08-12
2023-08-12;2023-08-18;Thu;2023-08-12
2023-08-12;2023-08-18;Fri;2023-08-19
2023-08-12;2023-08-18;Sat;2023-08-12
2023-08-12;2023-08-18;Sun;2023-08-12
2023-08-12;2023-08-12;Mon;2023-08-13
2023-08-12;2023-08-12;Tue;2023-08-13
2023-08-12;2023-08-12;Wed;2023-08-13
2023-08-12;2023-08-12;Thu;2023-08-13
2023-08-12;2023-08-12;Fri;2023-08-13
2023-08-12;2023-08-12;Sat;2023-08-13
2023-08-12;2023-08-12;Sun;2023-08-13
2023-08-12;2023-08-13;Mon;2023-08-14
2023-08-12;2023-08-13;Tue;2023-08-14
2023-08-12;2023-08-13;Wed;2023-08-14
2023-08-12;2023-08-13;Thu;2023-08-14
2023-08-12;2023-08-13;Fri;2023-08-14
2023-08-12;2023-08-13;Sat;2023-08-12
2023-08-12;2023-08-13;Sun;2023-08-14
2023-08-13;2023-08-14;Mon;2023-08-15
2023-08-13;2023-08-14;Tue;2023-08-15
2023-08-13;2023-08-14;Wed;2023-08-15
2023-08-13;2023-08-14;Thu;2023-08-15
2023-08-13;2023-08-14;Fri;2023-08-15
2023-08-13;2023-08-14;Sat;2023-08-15
2023-08-13;2023-08-14;Sun;2023-08-13
2023-08-13;2023-08-15;Mon;2023-08-13
2023-08-13;2023-08-15;Tue;2023-08-16
2023-08-13;2023-08-15;Wed;2023-08-16
2023-08-13;2023-08-15;Thu;2023-08-16
2023-08-13;2023-08-15;Fri;2023-08-16
2023-08-13;2023-08-15;Sat;2023-08-16
2023-08-13;2023-08-15;Sun;2023-08-13
2023-08-13;2023-08-16;Mon;2023-08-13
2023-08-13;2023-08-16;Tue;2023-08-13
2023-08-13;2023-08-16;Wed;2023-08-17
2023-08-13;2023-08-16;Thu;2023-08-17
2023-08-13;2023-08-16;Fri;2023-08-17
2023-08-13;2023-08-16;Sat;2023-08-17
2023-08-13;2023-08-16;Sun;2023-08-13
2023-08-13;2023-08-17;Mon;2023-08-13
2023-08-13;2023-08-17;Tue;2023-08-13
2023-08-13;2023-08-17;Wed;2023-08-13
2023-08-13;2023-08-17;Thu;2023-08-18
2023-08-13;2023-08-17;Fri;2023-08-18
2023-08-13;2023-08-17;Sat;2023-08-18
2023-08-13;2023-08-17;Sun;2023-08-13
2023-08-13;2023-08-18;Mon;2023-08-13
2023-08-13;2023-08-18;Tue;2023-08-13
2023-08-13;2023-08-18;Wed;2023-08-13
2023-08-13;2023-08-18;Thu;2023-08-13
2023-08-13;2023-08-18;Fri;2023-08-19
2023-08-13;2023-08-18;Sat;2023-08-19
2023-08-13;2023-08-18;Sun;2023-08-13
2023-08-13;2023-08-19;Mon;2023-08-13
2023-08-13;2023-08-19;Tue;2023-08-13
2023-08-13;2023-08-19;Wed;2023-08-13
2023-08-13;2023-08-19;Thu;2023-08-13
2023-08-13;2023-08-19;Fri;2023-08-13
2023-08-13;2023-08-19;Sat;2023-08-20
2023-08-13;2023-08-19;Sun;2023-08-13
2023-08-13;2023-08-13;Mon;2023-08-14
2023-08-13;2023-08-13;Tue;2023-08-14
2023-08-13;2023-08-13;Wed;2023-08-14
2023-08-13;2023-08-13;Thu;2023-08-14
2023-08-13;2023-08-13;Fri;2023-08-14
2023-08-13;2023-08-13;Sat;2023-08-14
2023-08-13;2023-08-13;Sun;2023-08-14"""

    def test_calculate_pickup_location_change_date(self):
        """
        Test that the pickup location change date is calculated correctly.
        """

        def parse_date(date_str):
            return datetime.strptime(date_str, "%Y-%m-%d").date()

        weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]

        for row in self.VALIDATION_DATA.split("\n"):
            cols = row.split(";")

            self.assertEqual(
                calculate_pickup_location_change_date(
                    parse_date(cols[0]), parse_date(cols[1]), weekdays.index(cols[2])
                ),
                parse_date(cols[3]),
            )


class DeliveryDateTestCase(TestCase):
    def test_calculate_next_delivery_date(self):
        # Test Case 1: reference_date is Monday (0), delivery_weekday is Friday (4)
        reference_date = date(2023, 1, 2)  # Monday
        delivery_weekday = 4  # Friday
        expected_date = date(2023, 1, 6)  # Should be the next Friday
        self.assertEqual(
            get_next_delivery_date(reference_date, delivery_weekday), expected_date
        )

        # Test Case 2: reference_date is Saturday (5), delivery_weekday is Wednesday (2)
        reference_date = date(2023, 1, 7)  # Saturday
        delivery_weekday = 2  # Wednesday
        expected_date = date(2023, 1, 11)  # Should be the next Wednesday
        self.assertEqual(
            get_next_delivery_date(reference_date, delivery_weekday), expected_date
        )

        # Test Case 3: reference_date is Wednesday (2), delivery_weekday is Wednesday (2)
        reference_date = date(2023, 1, 4)  # Wednesday
        delivery_weekday = 2
        expected_date = date(2023, 1, 4)
        self.assertEqual(
            get_next_delivery_date(reference_date, delivery_weekday), expected_date
        )
